<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>새물결 가을공연 소개</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    <header>
        <h1>AUTUMN BUSKING</h1>
        <h2>새물결 잔디광장 가을공연</h2>
    </header>

    <main>
        <section class="details fade-in">
            <h3>TIME & PLACE</h3>
            <p><strong>일시:</strong> 2025년 10월 10일 (금) PM 6:00</p>
            <p><strong>장소:</strong> 한국외대 잔디광장</p>
        </section>

        <section class="lineup fade-in">
            <h3>PHASE 1</h3>
            <div class="accordion">
                <div class="song-item">
                    <button class="song-title">Disco Yes</button>
                    <div class="performers">
                        <ul>
                            <li>V. 강혜원</li>
                            <li>K. 김도현</li>
                            <li>G1. 임진우</li>
                            <li>G2. 한호선</li>
                            <li>B. 이준혁</li>
                            <li>D. 김찬혁</li>
                        </ul>
                    </div>
                </div>
                <div class="song-item">
                    <button class="song-title">대화가 필요해</button>
                    <div class="performers">
                        <ul>
                            <li>V. 김지우&박훈탁</li>
                            <li>K. 김도현</li>
                            <li>G1. 한호선</li>
                            <li>G2. 김찬혁</li>
                            <li>B. 이준혁</li>
                            <li>D. 송현진</li>
                        </ul>
                    </div>
                </div>
                <div class="song-item">
                    <button class="song-title">선물</button>
                    <div class="performers">
                        <ul>
                            <li>V. 박훈탁</li>
                            <li>K. 김지우</li>
                            <li>D. 송현진</li>
                        </ul>
                    </div>
                </div>
                <div class="song-item">
                    <button class="song-title">숙녀에게</button>
                    <div class="performers">
                        <ul>
                            <li>V. 이재승</li>
                            <li>K1. 김지우</li>
                            <li>K2. 김도현</li>
                            <li>G1. 박훈탁</li>
                            <li>G2. 서현석</li>
                            <li>B. 이가연</li>
                            <li>D. 송현진</li>
                        </ul>
                    </div>
                </div>
                <div class="song-item">
                    <button class="song-title">비틀비틀 짝짜꿍</button>
                    <div class="performers">
                        <ul>
                            <li>V. 조유정</li>
                            <li>G. 이주원</li>
                            <li>B. 이가연</li>
                            <li>D. 윤시광</li>
                        </ul>
                    </div>
                </div>
                <div class="song-item">
                    <button class="song-title">첫사랑</button>
                    <div class="performers">
                        <ul>
                            <li>V. 문태영</li>
                            <li>G1. 김찬혁</li>
                            <li>G2. 김지현</li>
                            <li>B. 김도현</li>
                            <li>D. 송현진</li>
                        </ul>
                    </div>
                </div>
                <div class="song-item">
                    <button class="song-title">utatane</button>
                    <div class="performers">
                        <ul>
                            <li>V. 마쓰모토 유나</li>
                            <li>G. 이주원</li>
                            <li>B. 이준혁</li>
                            <li>D. 이태양</li>
                        </ul>
                    </div>
                </div>
                <div class="song-item">
                    <button class="song-title">Coffee Shop</button>
                    <div class="performers">
                        <ul>
                            <li>V. 황승범</li>
                            <li>G. 한호선</li>
                            <li>B. 이준혁</li>
                            <li>D. 김찬혁</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <section class="lineup fade-in">
            <h3>PHASE 2</h3>
            <div class="accordion">
                <div class="song-item">
                    <button class="song-title">The Sky is Crying</button>
                    <div class="performers">
                        <ul>
                            <li>V. 황승범</li>
                            <li>K. 김찬혁</li>
                            <li>G. 임진우</li>
                            <li>B. 한호선</li>
                            <li>D. 정주영</li>
                        </ul>
                    </div>
                </div>
                <div class="song-item">
                    <button class="song-title">For You</button>
                    <div class="performers">
                        <ul>
                            <li>V. 김윤지</li>
                            <li>K. 김찬혁</li>
                            <li>B. 김도현</li>
                            <li>D. 김민서</li>
                        </ul>
                    </div>
                </div>
                <div class="song-item">
                    <button class="song-title">Virtual Insanity</button>
                    <div class="performers">
                        <ul>
                            <li>V. 김서진</li>
                            <li>K. 김도현</li>
                            <li>G. 한호선</li>
                            <li>B. 이준혁</li>
                            <li>D. 박규정</li>
                        </ul>
                    </div>
                </div>
                <div class="song-item">
                    <button class="song-title">She</button>
                    <div class="performers">
                        <ul>
                            <li>V. 심필승</li>
                            <li>K. 정서진</li>
                            <li>G. 한호선</li>
                            <li>B. 김도현</li>
                            <li>D. 송현진</li>
                        </ul>
                    </div>
                </div>
                <div class="song-item">
                    <button class="song-title">비처럼 음악처럼</button>
                    <div class="performers">
                        <ul>
                            <li>V. 이재승</li>
                            <li>K. 김찬혁</li>
                            <li>G1. 한호선</li>
                            <li>G2. 이재승</li>
                            <li>B. 박시언</li>
                            <li>D. 송현진</li>
                        </ul>
                    </div>
                </div>
                <div class="song-item">
                    <button class="song-title">스물다섯, 스물하나</button>
                    <div class="performers">
                        <ul>
                            <li>V. 박윤아</li>
                            <li>K. 김윤지</li>
                            <li>G1. 김찬혁</li>
                            <li>G2. 김지현</li>
                            <li>B. 김도현</li>
                            <li>D. 이태양</li>
                        </ul>
                    </div>
                </div>
                <div class="song-item">
                    <button class="song-title">Ling Ling</button>
                    <div class="performers">
                        <ul>
                            <li>V. 이도경</li>
                            <li>K1. 정예원</li>
                            <li>K2. 김도현</li>
                            <li>G. 한호선</li>
                            <li>B. 박시언</li>
                            <li>D. 박규정</li>
                        </ul>
                    </div>
                </div>
                <div class="song-item">
                    <button class="song-title">우리의 밤</button>
                    <div class="performers">
                        <ul>
                            <li>V. 김서진 & 이재승</li>
                            <li>K. 김지우</li>
                            <li>G1. 이주원</li>
                            <li>G2. 박훈탁</li>
                            <li>B. 김찬혁</li>
                            <li>D. 정주영</li>
                        </ul>
                    </div>
                </div>
                <div class="song-item">
                    <button class="song-title">뜨거운 여름밤은 가고 <br>
                        남은 건 볼품없지만</button>
                    <div class="performers">
                        <ul>
                            <li>V. 이도경</li>
                            <li>K1. 김지우</li>
                            <li>K2. 정예원</li>
                            <li>G1. 임진우</li>
                            <li>G2. 박훈탁</li>
                            <li>B. 김도현</li>
                            <li>D. 송현진</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <section class="message-wall fade-in">
            <h3>롤링페이퍼</h3>
            <p class="subtitle">공연팀에게 따뜻한 응원을 남겨주세요!</p>
            <form id="message-form">
                <label for="message-input"></label><textarea id="message-input" placeholder="응원 메시지 입력..." maxlength="100" required></textarea>
                <button type="submit">남기기</button>
            </form>
            <div class="bubble-container" id="bubble-container">
            </div>
        </section>
    </main>

    <footer class="fade-in">
        <p>산뜻한 가을 바람과 함께 감상하는 밴드 버스킹 어떠세요?</p>
        <p>문의: suronpark@hufs.ac.kr</p>
    </footer>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // ----- 스크롤 애니메이션 (반복 실행되도록 수정) -----
        const fadeInElements = document.querySelectorAll('.fade-in');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // 화면에 보이면 'visible' 클래스 추가
                    entry.target.classList.add('visible');
                } else {
                    // 화면에서 사라지면 'visible' 클래스 제거
                    entry.target.classList.remove('visible');
                }
            });
        }, { threshold: 0.1 });
        fadeInElements.forEach(el => observer.observe(el));


        const form = document.getElementById('message-form');
        const input = document.getElementById('message-input');
        const bubbleContainer = document.getElementById('bubble-container');

        const colors = ['#ffadad', '#ffd6a5', '#fdffb6', '#caffbf', '#9bf6ff', '#a0c4ff', '#bdb2ff', '#ffc6ff'];
        let existingBubbles = [];

        async function loadMessages() {
            try {
                const response = await fetch('/api/messages');
                const messages = await response.json();
                bubbleContainer.innerHTML = '';
                existingBubbles = [];
                messages.forEach(createBubbleElement);
            } catch (error) {
                console.error('메시지를 불러오는 데 실패했습니다:', error);
            }
        }

        function createBubbleElement(message) {
            const bubble = document.createElement('div');
            bubble.classList.add('message-bubble');

            const content = document.createElement('p');
            content.textContent = message.content;

            bubble.appendChild(content);

            bubble.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];

            placeBubble(bubble);
            bubbleContainer.appendChild(bubble);
        }

        function placeBubble(bubble) {
            const containerRect = bubbleContainer.getBoundingClientRect();
            const bubbleWidth = 200; // CSS와 동일하게 너비 수정
            const bubbleHeight = 70; // CSS와 동일하게 높이 수정
            let attempts = 0;
            let isOverlapping;

            do {
                isOverlapping = false;
                const randomTop = Math.random() * (containerRect.height - bubbleHeight);
                const randomLeft = Math.random() * (containerRect.width - bubbleWidth);

                const newBubbleRect = {
                    top: randomTop, left: randomLeft,
                    right: randomLeft + bubbleWidth, bottom: randomTop + bubbleHeight
                };

                for (const existing of existingBubbles) {
                    if (!(newBubbleRect.right < existing.left ||
                        newBubbleRect.left > existing.right ||
                        newBubbleRect.bottom < existing.top ||
                        newBubbleRect.top > existing.bottom)) {
                        isOverlapping = true;
                        break;
                    }
                }

                if (!isOverlapping) {
                    bubble.style.top = `${randomTop}px`;
                    bubble.style.left = `${randomLeft}px`;
                    existingBubbles.push(newBubbleRect);
                }

                attempts++;
            } while (isOverlapping && attempts < 100);
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = input.value.trim();
            if (!content) return;

            try {
                // 1. 서버로 새 메시지 내용을 전송합니다.
                const response = await fetch('/api/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: content })
                });

                // 서버로부터 정상적인 응답(id가 포함된 메시지 객체)을 받습니다.
                if (!response.ok) {
                    throw new Error('서버 응답에 문제가 있습니다.');
                }

                const newMessage = await response.json();

                // 2. 서버로부터 받은 데이터로 화면에 말풍선을 생성합니다.
                createBubbleElement(newMessage);

                // 3. 입력창을 비웁니다.
                input.value = '';

            } catch (error) {
                console.error('메시지 전송 실패:', error);
                alert('메시지 전송에 실패했습니다.');
            }
        });

        loadMessages();
    });

    // ----- 아코디언 기능 -----
    const songTitles = document.querySelectorAll('.song-title');

    songTitles.forEach(title => {
        title.addEventListener('click', () => {
            // 현재 클릭한 아이템의 active 상태를 토글
            title.classList.toggle('active');

            const performers = title.nextElementSibling;
            if (performers.style.maxHeight) {
                performers.style.maxHeight = null; // 닫기
            } else {
                performers.style.maxHeight = performers.scrollHeight + "px"; // 열기
            }
        });
    });
</script>
</body>
</html>